input {
  tcp {
    port => 5000
    codec => json
  }
}

filter {
  # 로그 레벨 파싱
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level}" }
  }

  # 날짜 파싱
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }

  # 서비스명 추출
  if [logger_name] =~ /com\.subway\.(.+?)\./ {
    grok {
      match => { "logger_name" => "com\.subway\.(?<service>[^.]+)\." }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "subway-logs-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => rubydebug
  }
}